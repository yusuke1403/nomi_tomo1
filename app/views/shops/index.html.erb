<div class='main'>

<div id='map'>
</div>

<style>
#map{
  height: 700px;
  width: 1000px;
}
</style>

<script>
  // 現在地取得処理
  function initMap() {
    // Geolocation APIに対応している
    if (navigator.geolocation) {
      // 現在地を取得
      navigator.geolocation.getCurrentPosition(
        // 取得成功した場合
        function(position) {
          // 緯度・経度を変数に格納
          const mapLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          // マップオプションを変数に格納
          const mapOptions = {
            zoom : 14,          // 拡大倍率
            center : mapLatLng  // 緯度・経度
          };
          // マップオブジェクト作成
          const map = new google.maps.Map(
            document.getElementById("map"), // マップを表示する要素
            mapOptions         // マップオプション
          );
          // マップにマーカーを表示する
          const marker = new google.maps.Marker({
            map : map,             // 対象の地図オブジェクト
            position : mapLatLng,   // 緯度・経度
            icon: {
            url: ' http://maps.google.co.jp/mapfiles/ms/icons/red-pushpin.png', //アイコンのURL
            scaledSize: new google.maps.Size(40, 40) //サイズ
            }
          });
          // 複数マーカー
          <% @shops.each do |shop| %>
            (function(){
              let contentString = '<div id="content">'+
                '<p><%= shop.category %></p>'+
                '<%= link_to shop_path(shop.id), method: :get do %>'+
                '<p><b><%= shop.name %></b></p>'+
                '<% end %>'+
                '</div>';

              let marker_shop = new google.maps.Marker({
                position:{lat: <%= shop.latitude %>, lng: <%= shop.longitude %>},
                map: map,
                title: contentString, 
                icon: {
                url: ' http://maps.google.com/mapfiles/kml/pal2/icon19.png', //アイコンのURL
                scaledSize: new google.maps.Size(40, 40) //サイズ
                }
              });

              let infowindow = new google.maps.InfoWindow({
                position:{lat: <%= shop.latitude %>, lng: <%= shop.longitude %>},
                content: contentString
              });
                marker_shop.addListener('click', function() {
                infowindow.open(map, marker_shop);
              });
            })();
          <% end %>
        },

        // 取得失敗した場合
        function(error) {
          // エラーメッセージを表示
          switch(error.code) {
            case 1: // PERMISSION_DENIED
              alert("位置情報の利用が許可されていません");
              break;
            case 2: // POSITION_UNAVAILABLE
              alert("現在位置が取得できませんでした");
              break;
            case 3: // TIMEOUT
              alert("タイムアウトになりました");
              break;
            default:
              alert("その他のエラー(エラーコード:"+error.code+")");
              break;
          }
        }
      );
      // Geolocation APIに対応していない
    } else {
      alert("この端末では位置情報が取得できません");
    }
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY']%>&callback=initMap" async defer></script>

  <% @shops.each do |shop| %>
    <div class='list'>
      <%= link_to shop_path(shop.id), method: :get do %>
        <div class='shop-img'>
          <% shop.images.each do |image| %>
            <%= image_tag image.src%>
          <% end %>
        </div>
        <div class='shop-name'>
          <%= shop.name %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>